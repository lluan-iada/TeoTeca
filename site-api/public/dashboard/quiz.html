<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeoTeca | Quiz</title>
    <link rel="stylesheet" href="../css/quiz.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>

<body onload="validarSessao()">

    <header>
        <div class="header-logo">
            <img src="../assets/img/Logo - FundoTrans.png" class="titulo" alt="Logo">
            <span>
                <h2>TeoTeca</h2>
                <h3>Conhecimento que edifica</h3>
            </span>
        </div>

        <nav>
            <ul>
                <li>
                    <a href="../dashboard/dashboard.html"><span
                            class="material-symbols-outlined">dashboard</span>Dashboard</a>
                </li>
                <li>
                    <a href="./quiz.html"><span class="material-symbols-outlined">neurology</span>Quiz</a>
                </li>
                <li>
                    <a href="./blog.html"><span class="material-symbols-outlined">stylus_note</span>Blog</a>
                </li>
            </ul>
        </nav>
        <div class="header-usuario">
            <span id="b_usuario">...</span>
            <button onclick="limparSessao()"><span class="material-symbols-outlined">exit_to_app</span>Sair</button>
        </div>
    </header>

    <main id="pontuacaoEJogo">
        <div id="div_iniciarQuiz">
            <img src="../assets/img/Icon 2 - sobre.png">
            <h3>
                Quiz de Teologia
            </h3>
            <p>Teste seus conhecimentos sobre os pais da Igreja e o estopim da Reforma Protestante</p>
            <button id="btnIniciarQuiz" onclick="iniciarQuiz()">INICIAR QUIZ</button>
        </div>


        <div id="pontuacao" style="display: none;">
            <div>
                <span>Acertos: <span id="spanCertas">0</span></span>
                <span>Erros: <span id="spanErradas">0</span></span>
            </div>
            <div id="pontuacaoFinalJogo" style="display: none;">
                <span>Pontuação Final: <span id="spanPontuacaoFinal">***</span></span>
                <span id="msgFinal">***</span>
            </div>
        </div>

        <div id="jogo" style="display: none;">

            <div id="infoQuestao">
                <span>Questão <span id="spanNumeroDaQuestaoAtual"></span> de <span id="qtdQuestoes"></span></span>
            </div>

            <div id="perguntaDaQuestaoAtual">
                <h3 id="spanQuestaoExibida">...</h3>
            </div>

            <div id="opcoes"></div>

            <div id="botoes">
                <button onclick="submeter()" id="btnSubmeter">Confirmar</button>
                <button onclick="avancar()" id="btnProx" disabled>Próxima</button>
                <button onclick="location.reload()" id="btnTentarNovamente" style="display: none;">Tentar
                    Novamente</button>
            </div>

        </div>
    </main>

</body>

</html>

<script>
    var listaPerguntas = []
    var numeroDaQuestaoAtual = 0
    var pontuacaoFinal = 0
    var certas = 0
    var erradas = 0

    function validarSessao() {
        var nome = sessionStorage.NOME_USUARIO
        if (nome) document.getElementById("b_usuario").innerHTML = "Olá, " + nome
        else window.location = "../cadastro.html"
    }

    function limparSessao() {
        sessionStorage.clear()
        window.location = "../index.html"
    }

    function iniciarQuiz() {

        fetch("/quiz/perguntas/1")
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (json) {
                        listaPerguntas = json
                        comecarJogoRealmente()
                    })
                } else {
                    alert("Erro ao carregar perguntas")
                }
            })
    }

    function comecarJogoRealmente() {
        document.getElementById('div_iniciarQuiz').style.display = "none"
        document.getElementById('pontuacao').style.display = "flex"
        document.getElementById('jogo').style.display = "block"

        document.getElementById('qtdQuestoes').innerHTML = listaPerguntas.length
        preencherHTMLcomQuestaoAtual(0)
    }

    function preencherHTMLcomQuestaoAtual(index) {
        var questaoAtual = listaPerguntas[index]
        numeroDaQuestaoAtual = index

        document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = index + 1
        document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta

        var containerOpcoes = document.getElementById("opcoes")
        containerOpcoes.innerHTML = ""

        var letras = ['alternativaA', 'alternativaB', 'alternativaC', 'alternativaD']
        for (var i = 0; i < letras.length; i++) {
            var chave = letras[i]
            containerOpcoes.innerHTML += `
                <div>
                    <input type="radio" name="option" value="${chave}" id="opt_${chave}">
                    <label for="opt_${chave}" id="lbl_${chave}">${questaoAtual[chave]}</label>
                </div>
            `
        }

        document.getElementById("btnSubmeter").disabled = false
        document.getElementById("btnProx").disabled = true
    }

    function submeter() {
        var opcoes = document.getElementsByName("option")
        var selecionada = null

        for (var i = 0; i < opcoes.length; i++) {
            if (opcoes[i].checked) selecionada = opcoes[i].value
        }

        if (!selecionada) {
            alert("Escolha uma opção!")
            return
        }

        var correta = listaPerguntas[numeroDaQuestaoAtual].alternativaCorreta

        if (selecionada == correta) {
            pontuacaoFinal++
            certas++
            document.getElementById("spanCertas").innerHTML = certas
            document.getElementById(`lbl_${selecionada}`).style.color = "green"
            document.getElementById(`lbl_${selecionada}`).style.fontWeight = "bold"
        } else {
            erradas++
            document.getElementById("spanErradas").innerHTML = erradas
            document.getElementById(`lbl_${selecionada}`).style.color = "red"
            document.getElementById(`lbl_${correta}`).style.color = "green"
            document.getElementById(`lbl_${correta}`).style.fontWeight = "bold"
        }

        for (var i = 0; i < opcoes.length; i++) opcoes[i].disabled = true

        document.getElementById("btnSubmeter").disabled = true
        document.getElementById("btnProx").disabled = false
    }


    function avancar() {
        if (numeroDaQuestaoAtual < listaPerguntas.length - 1) {
            preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual + 1)
        } else {
            finalizarJogo()
        }
    }

    function finalizarJogo() {
        document.getElementById("jogo").style.display = "none"
        document.getElementById("pontuacaoFinalJogo").style.display = "block"

        document.getElementById("spanPontuacaoFinal").innerHTML = pontuacaoFinal + "/" + listaPerguntas.length

        var msg = pontuacaoFinal > 3 ? "Parabéns!" : "Estude mais!"
        document.getElementById("msgFinal").innerHTML = msg

        document.getElementById("btnTentarNovamente").style.display = "block"

        fetch("/quiz/quiz", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id_Usuario: sessionStorage.ID_USUARIO,
                id_Formulario: 1,
                pontuacao: pontuacaoFinal
            })
        }).then(res => { if (res.ok) console.log("Salvo") })
    }
</script>